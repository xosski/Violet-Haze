"use client";

import React, { useState, useRef, useEffect } from "react";
import { Card, CardContent, CardHeader, CardTitle } from "@/components/ui/card";
import { Button } from "@/components/ui/button";
import { Input } from "@/components/ui/input";
import { Badge } from "@/components/ui/badge";
import { Bug, Send, Trash2, History } from "lucide-react";
import { toast } from "sonner";

interface CommandEntry {
  id: string;
  input: string;
  output: string;
  timestamp: Date;
  status: "success" | "error" | "pending";
}

export function ExploitConsole() {
  const [command, setCommand] = useState("");
  const [history, setHistory] = useState<CommandEntry[]>([]);
  const [historyIndex, setHistoryIndex] = useState(-1);
  const consoleRef = useRef<HTMLDivElement>(null);
  const inputRef = useRef<HTMLInputElement>(null);

  useEffect(() => {
    if (consoleRef.current) {
      consoleRef.current.scrollTop = consoleRef.current.scrollHeight;
    }
  }, [history]);

  const simulatedCommands: Record<string, string> = {
    help: `Available commands:
  scan <target>      - Run vulnerability scan
  exploit <module>   - Load exploit module
  payload <type>     - Generate payload
  sessions           - List active sessions
  use <module>       - Use a specific module
  set <opt> <value>  - Set module option
  run                - Execute current module
  exit               - Exit console
  clear              - Clear console`,
    sessions: `Active Sessions:
  ID  Type         Info                    Connection
  --  ----         ----                    ----------
  1   meterpreter  x64/windows             192.168.1.100:4444 -> 10.0.0.5:49152
  2   shell        linux/x64               192.168.1.101:4445 -> 10.0.0.6:38921`,
    "scan 192.168.1.0/24": `[*] Starting network scan...
[+] Host 192.168.1.1 is up (0.001s latency)
    PORT     STATE SERVICE
    22/tcp   open  ssh
    80/tcp   open  http
[+] Host 192.168.1.100 is up (0.002s latency)
    PORT     STATE SERVICE
    445/tcp  open  microsoft-ds
    3389/tcp open  ms-wbt-server
[*] Scan complete: 2 hosts up`,
    "use exploit/windows/smb/ms17_010": `[*] Loading module: exploit/windows/smb/ms17_010
[*] Module options:
    RHOSTS    -    Target host(s)
    RPORT     445  Target port
    PAYLOAD   -    Payload to use`,
    run: `[*] Started reverse TCP handler on 10.0.0.1:4444
[*] Sending exploit...
[+] Exploit completed successfully
[*] Meterpreter session 3 opened (10.0.0.1:4444 -> 192.168.1.100:49153)`,
    whoami: `NT AUTHORITY\\SYSTEM`,
    "systeminfo | findstr /B /C:\"OS\"": `OS Name:                   Microsoft Windows Server 2019
OS Version:                10.0.17763 N/A Build 17763`,
  };

  const executeCommand = () => {
    if (!command.trim()) return;

    const entry: CommandEntry = {
      id: Date.now().toString(),
      input: command,
      output: "",
      timestamp: new Date(),
      status: "pending",
    };

    // Check for built-in commands
    if (command === "clear") {
      setHistory([]);
      setCommand("");
      return;
    }

    if (command === "exit") {
      toast.info("Console session ended");
      setCommand("");
      return;
    }

    // Find matching simulated output
    let output = simulatedCommands[command.toLowerCase()];
    if (!output) {
      // Check for partial matches
      const matchKey = Object.keys(simulatedCommands).find((key) =>
        command.toLowerCase().startsWith(key.split(" ")[0])
      );
      output = matchKey
        ? simulatedCommands[matchKey]
        : `[-] Unknown command: ${command}\nType 'help' for available commands`;
    }

    entry.output = output;
    entry.status = output.includes("[-]") ? "error" : "success";

    setHistory((prev) => [...prev, entry]);
    setCommand("");
    setHistoryIndex(-1);
  };

  const handleKeyDown = (e: React.KeyboardEvent) => {
    if (e.key === "Enter") {
      executeCommand();
    } else if (e.key === "ArrowUp") {
      e.preventDefault();
      const commands = history.filter((h) => h.input);
      if (commands.length > 0) {
        const newIndex = historyIndex < commands.length - 1 ? historyIndex + 1 : historyIndex;
        setHistoryIndex(newIndex);
        setCommand(commands[commands.length - 1 - newIndex]?.input || "");
      }
    } else if (e.key === "ArrowDown") {
      e.preventDefault();
      if (historyIndex > 0) {
        const commands = history.filter((h) => h.input);
        const newIndex = historyIndex - 1;
        setHistoryIndex(newIndex);
        setCommand(commands[commands.length - 1 - newIndex]?.input || "");
      } else {
        setHistoryIndex(-1);
        setCommand("");
      }
    }
  };

  return (
    <Card className="border-red-500/30">
      <CardHeader className="flex flex-row items-center justify-between">
        <CardTitle className="flex items-center gap-2">
          <Bug className="h-5 w-5 text-red-500" />
          Exploit Console
        </CardTitle>
        <div className="flex gap-2">
          <Badge variant="outline" className="font-mono">
            {history.length} commands
          </Badge>
          <Button
            size="sm"
            variant="ghost"
            onClick={() => setHistory([])}
          >
            <Trash2 className="h-4 w-4" />
          </Button>
        </div>
      </CardHeader>
      <CardContent className="space-y-4">
        {/* Console Output */}
        <div
          ref={consoleRef}
          className="terminal-output h-80 overflow-y-auto font-mono text-sm"
          onClick={() => inputRef.current?.focus()}
        >
          <div className="text-red-400 mb-2">
            ╔══════════════════════════════════════════╗
            ║     PURPLE TEAM OPS - EXPLOIT CONSOLE    ║
            ╚══════════════════════════════════════════╝
          </div>
          <div className="text-yellow-400 mb-4">
            Type 'help' for available commands
          </div>

          {history.map((entry) => (
            <div key={entry.id} className="mb-2">
              <div className="flex items-center gap-2">
                <span className="text-red-400">exploit</span>
                <span className="text-gray-400">&gt;</span>
                <span className="text-white">{entry.input}</span>
              </div>
              <pre
                className={`whitespace-pre-wrap ${
                  entry.status === "error" ? "text-red-400" : "text-green-400"
                }`}
              >
                {entry.output}
              </pre>
            </div>
          ))}

          {/* Current prompt */}
          <div className="flex items-center gap-2">
            <span className="text-red-400">exploit</span>
            <span className="text-gray-400">&gt;</span>
            <span className="text-white">{command}</span>
            <span className="animate-pulse">▌</span>
          </div>
        </div>

        {/* Command Input */}
        <div className="flex gap-2">
          <Input
            ref={inputRef}
            value={command}
            onChange={(e) => setCommand(e.target.value)}
            onKeyDown={handleKeyDown}
            placeholder="Enter command..."
            className="font-mono"
            autoFocus
          />
          <Button onClick={executeCommand} variant="red">
            <Send className="h-4 w-4" />
          </Button>
        </div>

        {/* Quick Commands */}
        <div className="flex flex-wrap gap-2">
          <span className="text-xs text-muted-foreground">Quick:</span>
          {["help", "sessions", "scan 192.168.1.0/24", "use exploit/windows/smb/ms17_010"].map(
            (cmd) => (
              <Badge
                key={cmd}
                variant="secondary"
                className="cursor-pointer hover:bg-secondary/80 font-mono text-xs"
                onClick={() => {
                  setCommand(cmd);
                  inputRef.current?.focus();
                }}
              >
                {cmd}
              </Badge>
            )
          )}
        </div>
      </CardContent>
    </Card>
  );
}
